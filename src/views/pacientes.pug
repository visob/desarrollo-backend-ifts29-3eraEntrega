doctype html
html(lang='es')
  head
    meta(charset='UTF-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    title= title
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap')
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css')
    style.
      /* --- Estilos Base del Dashboard (Layout) --- */
      body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 24px;
        background: linear-gradient(135deg, #f6fbff, #e9f6ff);
        color: #0f4c81;
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 80px;
        background: linear-gradient(180deg, rgba(6,40,60,0.95), rgba(5,34,54,0.95));
        color: white;
        border-radius: 12px;
        padding: 20px 12px;
        display:flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
        box-shadow: 0 12px 30px rgba(2,6,23,0.12);
        position: sticky;
        top: 24px;
        height: calc(100vh - 48px);
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: linear-gradient(135deg,#0b74b6,#0b4fa0);
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:700;
      }

      .sidebar nav a {
        width: 52px;
        height: 52px;
        border-radius: 10px;
        display:flex;
        align-items:center;
        justify-content:center;
        color: rgba(255,255,255,0.9);
        text-decoration: none;
        font-size: 1.2em;
        transition: transform .18s ease, box-shadow .18s ease;
      }
      .sidebar nav a:hover {
        transform: translateY(-6px);
        box-shadow: 0 10px 26px rgba(4,30,60,0.28);
      }

      .main {
        flex: 1;
        margin-left: 24px;
      }

      .container {
        background: rgba(255,255,255,0.75);
        padding: 28px;
        border-radius: 16px;
        box-shadow: 0 14px 40px rgba(2,6,23,0.08);
      }
      
      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .header-left i {
        font-size: 1.9rem;
        color: #0f4c81;
      }
      .header-left h1 {
        font-size: 1.9rem;
        margin: 4px 0;
      }
      .page-sub {
        margin: 0;
        color: #5b7f98;
      }

      /* --- Estilos Específicos de Pacientes (Fusionados) --- */
      .actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }
      .action-button {
        display: block;
        padding: 20px;
        text-decoration: none;
        border-radius: 10px;
        text-align: center;
        font-weight: bold;
        font-size: 1.1em;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        color: white;
      }
      .action-button:hover {
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
      }
      .action-button .icon { /* Estilo para el ícono dentro del botón */
        font-size: 2em;
        display: block;
        margin-bottom: 10px;
      }
      .create {
        background: linear-gradient(135deg, #48bb78, #38a169);
        box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
      }
      .create:hover {
        box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
      }
      .read {
        background: linear-gradient(135deg, #4299e1, #3182ce);
        box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
      }
      .read:hover {
        box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
      }
      .update {
        background: linear-gradient(135deg, #ed8936, #dd6b20);
        box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
      }
      .update:hover {
        box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
      }
      .delete {
        background: linear-gradient(135deg, #f56565, #e53e3e);
        box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
      }
      .delete:hover {
        box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
      }
      .form-section {
        background: #f7fafc;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        display: none;
        border: 1px solid rgba(12,50,80,0.04);
      }
      .form-section h3 {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #2d3748;
      }
      .form-section.active {
        display: block;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #2d3748;
      }
      .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e0;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box; /* Añadido para consistencia de tamaño */
      }
      .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #0b74b6;
        box-shadow: 0 0 0 3px rgba(11, 116, 182, 0.1);
      }
      .submit-button {
        background: #0b74b6;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s ease;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .submit-button:hover {
        background: #0b4fa0;
      }
      .result {
        background: #edf2f7;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        display: none;
      }
      .result i { /* Estilo para íconos en resultados */
        margin-right: 8px;
      }
      .result.success {
        background: #f0fff4;
        border-left: 4px solid #48bb78;
        color: #2f855a;
      }
      .result.success i {
        color: #48bb78;
      }
      .result.error {
        background: #fed7d7;
        border-left: 4px solid #f56565;
        color: #c53030;
      }
      .result.error i {
        color: #f56565;
      }

      /* --- Estilos de tarjetas reutilizables --- */
      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 12px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        border: 1px solid rgba(12,50,80,0.06);
        box-shadow: 0 10px 24px rgba(2,6,23,0.06);
        overflow: hidden;
        transition: transform .18s ease, box-shadow .18s ease;
      }
      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 14px 32px rgba(2,6,23,0.10);
      }
      .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 16px;
        border-bottom: 1px solid rgba(12,50,80,0.06);
      }
      .card-header i {
        color: #0f4c81;
        font-size: 1.2rem;
      }
      .card-title {
        font-weight: 600;
        color: #0f4c81;
      }
      .card-body {
        padding: 12px 16px 16px;
      }
      .card-body p {
        margin: 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #2d3748;
      }
      .card-body p i {
        color: #5b7f98;
      }

  body
    include partials/sidebar.pug
    +sidebar(user)

    .main
      .container
        // --- Cabecera con ícono ---
        .header-left
          i.fas.fa-user-injured
          h1.page-title Gestión de Pacientes
          p.page-sub Desarrollo Backend - Grupo 4
          if user
            p.page-sub Bienvenido, #{user.username} · Rol: #{user.role}
            a(href='#', onclick='logout()') Cerrar sesión
          else
            a(href='/login') Iniciar sesión

        // --- Contenido de la página de Pacientes con íconos ---
        .actions
          if user && user.role === 'Administrativo'
            a.action-button.create(href='#' onclick='showForm("create")')
              i.icon.fas.fa-plus-circle
              | Crear Paciente
            a.action-button.read(href='#' onclick='showForm("read")')
              i.icon.fas.fa-search
              | Consultar Pacientes
            a.action-button.update(href='#' onclick='showForm("update")')
              i.icon.fas.fa-edit
              | Modificar Paciente
            a.action-button.delete(href='#' onclick='showForm("delete")')
              i.icon.fas.fa-trash-alt
              | Eliminar Paciente
          else if user && user.role === 'Medico'
            a.action-button.read(href='#' onclick='showForm("read")')
              i.icon.fas.fa-search
              | Consultar Pacientes
          else if user && user.role === 'Paciente'
            p.page-sub Solo personal administrativo puede gestionar pacientes.
        
        // Formulario Crear Paciente
        .form-section#create-form
          h3
            i.fas.fa-plus-circle
            | Crear Nuevo Paciente
          form(onsubmit='createPaciente(event)')
            .form-group
              label(for='nombre') Nombre:
              input(type='text' id='nombre' name='nombre' required)
            .form-group
              label(for='apellido') Apellido:
              input(type='text' id='apellido' name='apellido' required)
            .form-group
              label(for='dni') DNI:
              input(type='text' id='dni' name='dni' required)
            .form-group
              label(for='edad') Edad:
              input(type='number' id='edad' name='edad' required min='0' max='120')
            .form-group
              label(for='sexo') Sexo:
              select(id='sexo' name='sexo' required)
                option(value='') Seleccionar...
                option(value='M') Masculino
                option(value='F') Femenino
            .form-group
              label(for='obraSocial') Obra Social:
              input(type='text' id='obraSocial' name='obraSocial' required)
            .form-group
              label(for='nroAfiliado') Número de Afiliado:
              input(type='text' id='nroAfiliado' name='nroAfiliado' required)
            button.submit-button(type='submit') Crear Paciente
          .result#create-result
        
        // Formulario Consultar Pacientes
        .form-section#read-form
          h3
            i.fas.fa-search
            | Consultar Pacientes
          button.submit-button(onclick='getAllPacientes()') Ver Pacientes
          .form-group(style='margin-top: 20px;')
            label(for='searchDni') Buscar por DNI:
            input(type='text' id='searchDni' name='searchDni' placeholder='Ingrese DNI')
            button.submit-button(onclick='getPacienteByDni()') Buscar
          // Contenedor de resultados en tarjetas
          .result#read-result
        
        // Formulario Modificar Paciente
        .form-section#update-form
          h3
            i.fas.fa-edit
            | Modificar Paciente
          .form-group
            label(for='updatePacienteSelect') Seleccionar Paciente:
            select(id='updatePacienteSelect' name='updatePacienteSelect' required)
              option(value='') Seleccionar paciente...
            button.submit-button(onclick='loadPacienteData()') Cargar Datos
          form(onsubmit='updatePaciente(event)' style='display:none' id='update-data-form')
            .form-group
              label(for='updateNombre') Nombre:
              input(type='text' id='updateNombre' name='updateNombre' required)
            .form-group
              label(for='updateApellido') Apellido:
              input(type='text' id='updateApellido' name='updateApellido' required)
            .form-group
              label(for='updateDni') DNI:
              input(type='text' id='updateDni' name='updateDni' required)
            .form-group
              label(for='updateEdad') Edad:
              input(type='number' id='updateEdad' name='updateEdad' required min='0' max='120')
            .form-group
              label(for='updateSexo') Sexo:
              select(id='updateSexo' name='updateSexo' required)
                option(value='M') Masculino
                option(value='F') Femenino
            .form-group
              label(for='updateObraSocial') Obra Social:
              input(type='text' id='updateObraSocial' name='updateObraSocial' required)
            .form-group
              label(for='updateNroAfiliado') Número de Afiliado:
              input(type='text' id='updateNroAfiliado' name='updateNroAfiliado' required)
            button.submit-button(type='submit') Actualizar Paciente
          .result#update-result
        
        // Formulario Eliminar Paciente
        .form-section#delete-form
          h3
            i.fas.fa-trash-alt
            | Eliminar Paciente
          .form-group
            label(for='deleteId') Seleccionar Paciente:
            select(id='deleteId' name='deleteId' required)
              option(value='') Seleccionar paciente...
            button.submit-button(onclick='deletePaciente()') Eliminar Paciente
          .result#delete-result

    // --- Componente reusable de tarjeta ---
    mixin CardSimple(icon, title)
      .card
        .card-header
          i(class=icon)
          .card-title= title
        block

    // --- Script modificado para usar íconos ---
    script.
      function showForm(formType) {
        // Ocultar todos los formularios
        const forms = document.querySelectorAll('.form-section');
        forms.forEach(form => form.classList.remove('active'));
        
        // Mostrar el formulario seleccionado
        document.getElementById(formType + '-form').classList.add('active');
        
        // Cargar pacientes en el desplegable si es el formulario de modificar
        if (formType === 'update') {
          loadPacientesDropdown('updatePacienteSelect');
        }
        if (formType === 'delete') {
          loadPacientesDropdown('deleteId');
        }
        
        // Limpiar resultados
        const results = document.querySelectorAll('.result');
        results.forEach(result => {
          result.style.display = 'none';
          result.innerHTML = '';
        });
      }

      function showResult(elementId, message, isSuccess = true) {
        const result = document.getElementById(elementId);
        const iconHtml = isSuccess ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
        result.innerHTML = `${iconHtml} ${message}`;
        result.className = 'result ' + (isSuccess ? 'success' : 'error');
        result.style.display = 'block';
      }

      async function createPaciente(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = {
          Nombre: formData.get('nombre'),
          Apellido: formData.get('apellido'),
          DNI: formData.get('dni'),
          Edad: formData.get('edad'),
          Sexo: formData.get('sexo'),
          ObraSocial: formData.get('obraSocial'),
          NroAfiliado: formData.get('nroAfiliado')
        }
        
        try {
          const response = await fetch('/api/pacientes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          if (response.ok) {
            const id = result.data._id || result.data.IdPaciente;
            // Mensaje sin emoji
            showResult('create-result', `Paciente creado exitosamente. ID: ${id}`, true);
            event.target.reset();
          } else {
            showResult('create-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('create-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function getAllPacientes() {
        try {
          const response = await fetch('/api/pacientes');
          const result = await response.json();
          
          if (response.ok) {
            const container = document.getElementById('read-result');
            container.className = 'result success';
            container.style.display = 'block';
            // Construir grid de tarjetas (sin ID)
            let html = '<div class="cards-grid">';
            result.data.slice(0, 10).forEach(paciente => {
              const nombreCompleto = `${paciente.Nombre} ${paciente.Apellido}`;
              html += `
                <div class="card paciente-card" onclick="selectPacienteDni('${paciente.DNI || ''}')">
                  <div class="card-header">
                    <i class="fas fa-id-card"></i>
                    <div class="card-title">${nombreCompleto}</div>
                  </div>
                  <div class="card-body">
                    <p><i class="fas fa-id-badge"></i> DNI: ${paciente.DNI || '-'}</p>
                    <p><i class="fas fa-file-medical"></i> Obra Social: ${paciente.ObraSocial || '-'}</p>
                  </div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = `<h4><i class="fas fa-clipboard-list"></i> Lista de Pacientes:</h4>${html}`;
          } else {
            showResult('read-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('read-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function getPacienteByDni() {
        const dni = document.getElementById('searchDni').value;
        if (!dni) {
          showResult('read-result', 'Por favor ingrese un DNI', false);
          return;
        }
        
        try {
          const response = await fetch(`/api/pacientes/dni/${dni}`);
          const result = await response.json();
          
          if (response.ok) {
            const p = result.data;
            const container = document.getElementById('read-result');
            container.className = 'result success';
            container.style.display = 'block';
            const nombreCompleto = `${p.Nombre} ${p.Apellido}`;
            // Obtener último turno del paciente
            const idPaciente = p._id || p.IdPaciente;
            let ultimoTurnoHtml = '<p><i class="fas fa-calendar-times"></i> No tiene turno registrado.</p>';
            if (idPaciente) {
              try {
                const respTurnos = await fetch(`/api/turnos/paciente/${idPaciente}`);
                const resultTurnos = await respTurnos.json();
                if (respTurnos.ok && Array.isArray(resultTurnos.data) && resultTurnos.data.length > 0) {
                  // Verificar que efectivamente correspondan al paciente
                  const turnosDelPaciente = resultTurnos.data.filter(t => {
                    const tId = (t.IdPaciente && (t.IdPaciente._id || t.IdPaciente)) || t.IdPaciente;
                    return tId == idPaciente;
                  });
                  if (turnosDelPaciente.length > 0) {
                    // Ordenar por fecha y hora de inicio y tomar el último
                    turnosDelPaciente.sort((a, b) => {
                      const ta = new Date(`${a.Fecha}T${a.HoraInicio || '00:00'}:00`).getTime();
                      const tb = new Date(`${b.Fecha}T${b.HoraInicio || '00:00'}:00`).getTime();
                      return ta - tb;
                    });
                    const ultimo = turnosDelPaciente[turnosDelPaciente.length - 1];
                    const d = new Date(ultimo.Fecha);
                    const dia = String(d.getUTCDate()).padStart(2, '0');
                    const mes = String(d.getUTCMonth() + 1).padStart(2, '0');
                    const anio = d.getUTCFullYear();
                    const fechaStr = `${dia}/${mes}/${anio}`;
                    const horaInicio = ultimo.HoraInicio || '';
                    const horaFin = ultimo.HoraFin || '';
                    // Obtener nombre del médico del último turno
                    let medicoNombre = 'N/A';
                    try {
                      const idMedico = (ultimo.IdMedico && (ultimo.IdMedico._id || ultimo.IdMedico)) || ultimo.IdMedico;
                      if (idMedico) {
                        const respMedico = await fetch(`/api/medicos/${idMedico}`);
                        const resultMedico = await respMedico.json();
                        if (respMedico.ok && resultMedico.data) {
                          medicoNombre = `${resultMedico.data.Nombre} ${resultMedico.data.Apellido}`;
                        }
                      }
                    } catch (e) {
                      console.error('Error al obtener médico del último turno:', e);
                    }
                    // Fallback si el turno ya trae objeto Médico embebido
                    if (medicoNombre === 'N/A' && ultimo.IdMedico && ultimo.IdMedico.Nombre && ultimo.IdMedico.Apellido) {
                      medicoNombre = `${ultimo.IdMedico.Nombre} ${ultimo.IdMedico.Apellido}`;
                    }
                    ultimoTurnoHtml = `
                      <p><i class=\"fas fa-calendar-check\"></i> Último turno: ${fechaStr}</p>
                      <p><i class=\"fas fa-clock\"></i> Horario: ${horaInicio}${horaFin ? ' - ' + horaFin : ''}</p>
                      <p><i class=\"fas fa-user-md\"></i> Médico: ${medicoNombre}</p>
                    `;
                  }
                }
              } catch (e) {
                console.error('Error al obtener último turno:', e);
              }
            }

            const html = `
              <h4><i class=\"fas fa-user\"></i> Paciente Encontrado:</h4>
              <div class=\"cards-grid\">
                <div class=\"card paciente-card\" onclick=\"selectPacienteDni('${p.DNI || ''}')\">
                  <div class=\"card-header\">
                    <i class=\"fas fa-id-card\"></i>
                    <div class=\"card-title\">${nombreCompleto}</div>
                  </div>
                  <div class=\"card-body\">
                    <p><i class=\"fas fa-id-badge\"></i> DNI: ${p.DNI || '-'}</p>
                    <p><i class=\"fas fa-venus-mars\"></i> Sexo: ${p.Sexo || '-'}</p>
                    <p><i class=\"fas fa-calendar-alt\"></i> Edad: ${p.Edad || '-'} años</p>
                    <p><i class=\"fas fa-file-medical\"></i> Obra Social: ${p.ObraSocial || '-'}</p>
                    <p><i class=\"fas fa-id-card-clip\"></i> Nro. Afiliado: ${p.NroAfiliado || '-'}</p>
                    ${ultimoTurnoHtml}
                  </div>
                </div>
              </div>`;
            container.innerHTML = html;
          } else {
            showResult('read-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('read-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function loadPacientesDropdown(idSelect) {
        try {
          const response = await fetch('/api/pacientes');
          const result = await response.json();
          
          if (response.ok) {
            const select = document.getElementById(idSelect);
            select.innerHTML = '<option value="">Seleccionar paciente...</option>';
            
            result.data.forEach(paciente => {
              const id = paciente._id || paciente.IdPaciente;
              const option = document.createElement('option');
              option.value = id;
              option.textContent = `${paciente.Nombre} ${paciente.Apellido} - DNI: ${paciente.DNI}`;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Error cargando pacientes:', error);
        }
      }

      async function loadPacienteData() {
        const id = document.getElementById('updatePacienteSelect').value;
        if (!id) {
          showResult('update-result', 'Por favor seleccione un paciente', false);
          return;
        }
        
        try {
          const response = await fetch(`/api/pacientes/${id}`);
          const result = await response.json();
          
          if (response.ok) {
            const p = result.data;
            document.getElementById('updateNombre').value = p.Nombre;
            document.getElementById('updateApellido').value = p.Apellido;
            document.getElementById('updateDni').value = p.DNI;
            document.getElementById('updateEdad').value = p.Edad;
            document.getElementById('updateSexo').value = p.Sexo;
            document.getElementById('updateObraSocial').value = p.ObraSocial;
            document.getElementById('updateNroAfiliado').value = p.NroAfiliado;
            
            document.getElementById('update-data-form').style.display = 'block';
            showResult('update-result', 'Datos cargados correctamente', true);
          } else {
            showResult('update-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('update-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function updatePaciente(event) {
        event.preventDefault();
        const id = document.getElementById('updatePacienteSelect').value;
        const formData = new FormData(event.target);
        const data = {
          Nombre: formData.get('updateNombre'),
          Apellido: formData.get('updateApellido'),
          DNI: formData.get('updateDni'),
          Edad: formData.get('updateEdad'),
          Sexo: formData.get('updateSexo'),
          ObraSocial: formData.get('updateObraSocial'),
          NroAfiliado: formData.get('updateNroAfiliado')
        }
        
        try {
          const response = await fetch(`/api/pacientes/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          if (response.ok) {
            showResult('update-result', 'Paciente actualizado exitosamente', true);
          } else {
            showResult('update-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('update-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function deletePaciente() {
        const id = document.getElementById('deleteId').value;
        if (!id) {
          showResult('delete-result', 'Por favor seleccione un paciente', false);
          return;
        }
        
        if (!confirm('¿Está seguro de que desea eliminar este paciente?')) {
          return;
        }
        
        try {
          const response = await fetch(`/api/pacientes/${id}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          if (response.ok) {
            showResult('delete-result', 'Paciente eliminado exitosamente', true);
            document.getElementById('deleteId').value = '';
            // Recargar la lista de pacientes en los dropdowns
            loadPacientesDropdown('updatePacienteSelect');
            loadPacientesDropdown('deleteId');
          } else {
            showResult('delete-result', `Error: ${result.message}`, false);
          }
        } catch (error) {
          showResult('delete-result', `Error de conexión: ${error.message}`, false);
        }
      }

      async function logout(){
        try {
          const response = await fetch('/api/auth/logout', { method: 'POST' });
          const data = await response.json();
          if (response.ok) {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
          } else {
            alert(data.message || 'Error al cerrar sesión');
          }
        } catch (e) {
          alert('Error de conexión: ' + e.message);
        }
      }

      function selectPacienteDni(dni) {
        try {
          const input = document.getElementById('searchDni');
          if (input) {
            input.value = dni || '';
            if (typeof getPacienteByDni === 'function') {
              getPacienteByDni();
            } else {
              const form = document.getElementById('buscar-dni-form') || input.closest('form');
              if (form) form.dispatchEvent(new Event('submit', { bubbles: true }));
            }
          }
        } catch (e) {
          console.error('Error al seleccionar DNI del paciente:', e);
        }
      }